---
title: "Wearables Pre-Post Data Report (06.20.2025)"
author: "Laura Graham"
date: "`r Sys.Date()`"
output: 
  github_document:
    html_preview: false
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyquant)
library(procs)
library(gtsummary)
library(readxl)
library(gridExtra)

# Load Current Step Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_Steps.RData")

# Load Current HR Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_MVPA.RData")

# Load Current Sleep Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_Sleep.RData")

# Merge all Wearables
  daily <- merge(daily_steps, daily_mvpa, by=c("ID", "date"), all.x=T, all.y=T)
  daily <- merge(daily, daily_sleep, by=c("ID", "date"), all.x=T, all.y=T)
  
  daily <- daily[,c("ID", "date", "Total_Steps", "Total_MVPA", "Total_Sleep", "HR_Avg", "HR_Max", "HR_n", "Moderate", "Vigorous", "Sleep_Start", "Sleep_End")]

  # Participant level with day daily
    participant <- daily %>%
      dplyr::group_by(ID) %>%
      dplyr::summarize(Avg_Daily_Steps = mean(Total_Steps, na.rm=T), 
                       Avg_MVPA = mean(Total_MVPA, na.rm=T),
                       Avg_Sleep = mean(Total_Sleep, na.rm=T),
                       start_date = min(date), last_date = max(date)) 
  
    # Pre-Post Determinimation
    daily$Pre.Post <- ifelse(daily$date < as.Date('2024-09-15'), "Pre", "Post")
    daily$Pre.Post <- factor(daily$Pre.Post, levels=c("Pre", "Post"))
      table(daily$Pre.Post)
    daily$Times <- ifelse(daily$date < as.Date('2024-05-16'), "1. May 15 or earlier",
                          ifelse(daily$date <= as.Date('2024-06-28'), "2. Pre Intro to DCI (06/28/2024)",
                                 ifelse(daily$date <= as.Date('2024-08-01'), "3. Pre Virtual Orientation (08/01/2024)",
                                        ifelse(daily$date < as.Date('2024-09-15'), "4. Pre In-Person Orientation (09/15/2024)", "5. Post DCI Orientation"))))
      table(daily$Times)

# Demographics
  Demo <- read_excel("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/2024 Master List.xlsx", sheet = "Master")

# Survey Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Survey Data/Survey_2024_07092024.RData")
  survey <- survey2024[,c("id_number2", "Q156_1", "Q127", "Q129", "Q153")]
  
# TruDiagnostics
  Trudiagnostics <- read.csv("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/TruDiagnostics Data/PopulationData_11192024.csv", header=TRUE)
  Trudiagnostics <- Trudiagnostics[,c("Patient.ID", "Telomere.Values", "OMICmAge", "Decimal.Chronological.Age")]

# Combine all data
  daily2 <- merge(daily, Demo, by = "ID", all.x = T)
  daily2 <- merge(daily2, survey, by.x = "Old ID", by.y = "id_number2", all.x = T)
  daily2 <- merge(daily2, Trudiagnostics, by.x = "TruDiagnosticID", by.y = "Patient.ID", all.x = T)
  
  daily2 <- labelled::copy_labels(from = survey, to = daily2)

# Cleaning Labels
  labelled::var_label(daily2$Pre.Post) <- "Pre/Post DCI"
  labelled::var_label(daily2$gender) <- "Gender"
  labelled::var_label(daily2$education) <- "Education"
  labelled::var_label(daily2$Usborn) <- "Born in US"
  labelled::var_label(daily2$married) <- "Marital Status"
  labelled::var_label(daily2$children_living2) <- "Number of Children"
  labelled::var_label(daily2$selfemployed) <- "Self-Employed"
    daily2$rate_health <- factor(daily2$rate_health, levels = c("Excellent", "Very Good", "Good", "Fair", "Poor"))
  labelled::var_label(daily2$rate_health) <- "Self-Reported Health"
  daily2$Q156_1<- plyr::revalue(as.character(daily2$Q156_1), 
                                     c("5" = "Very Satisfied", 
                                       "4" = "Satisfied", 
                                       "3" = "Neither Dissatisfied nor Satisfied", 
                                       "2" = "Dissatisfied", 
                                       "1" = "Very Dissatisfied"))
  labelled::var_label(daily2$Q156_1) <- "How satisfied are you with your health?"
 
```
# Summary

DCI participants take an average of 14,406 steps per day which includes an average of 119 minutes of moderate to vigorous physical activity (MVPA).

After starting DCI, only female participants see an increase in daily step count (+1,193 steps per day). Male DCI participants reduce their daily step counts by 2,219 steps after starting DCI.

MVPA increases across all participants by 18 minutes as compared to the pre-Intro to DCI period.

# Notes
All models include a random effect for the participant and are adjusted for device type used to capture the data.

# Data Frame Summary

```{r, warning=FALSE, echo=FALSE, message = FALSE}

skimr::skim(daily2)

```


# Step Count Analysis

## Distribution of Daily Step Counts

```{r, echo=FALSE, message = FALSE, warning=FALSE}

    # Exclude dates prior to May 16, 2024)
      daily2 <- subset(daily2, date > as.Date("2024-05-16"))
      daily2 <- labelled::copy_labels(from = daily_steps, to = daily2)
      
      mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Total_Steps, na.rm=T))
      
      mu
      
      ggplot(daily2, aes(x = Total_Steps, y = ..density..)) +
        geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
        geom_density(colour = "red") + theme_bw() +  
        ggtitle("Average Daily Step Counts Across All Time for Participants")+
        labs(x = "Average Daily Steps", y = "Density")
```

## Daily Step Counts by Time Period

```{r, echo=FALSE, message = FALSE, warning=FALSE}

    # Initial Table
      tbl_summary(data = daily2, by=Times, include=Total_Steps, 
                  type = all_continuous() ~ "continuous2",
                  statistic = all_continuous() ~ c(
                    "{mean} ({sd})",
                    "{median} ({p25}, {p75})",
                    "{min}, {max}"                  ),
                  digits = all_continuous() ~ 0,
                  label = Total_Steps ~ "Daily Steps"                 ) |> 
        add_overall() 
      
```


## Plotting Change in Daily Steps Over Time

```{r, echo=FALSE, message = FALSE, warning=FALSE, fig.width=8}
      ggplot(daily2, aes(x = date, y = Total_Steps)) + 
        geom_smooth(colour = "red") + 
        scale_x_datetime(date_breaks="1 month", date_labels="%b\n%Y") +
        labs( x = "Average Daily Steps", y = "Density")+
        theme_bw()
```

## Daily Steps by Device and Survey Responses

```{r, echo=FALSE, message = FALSE, warning=FALSE}
  
  tbl_continuous(data=daily2, variable = Total_Steps, include = c("gender", "education", "Usborn",
                                                                  "married", "children_living2", "selfemployed",
                                                                  "rate_health", "Q156_1", "Q127", "Q129", 
                                                                  "Q153")) |> add_p()
  
  my_data <- daily2[, c("Total_Steps", "Age", "OMICmAge", "UCLA_Loneliness_Rev")]
    correlation::correlation(my_data)
```

## Unadjusted and Adjusted model of Daily Step Counts
Includes a random effect for participants and adjustment for device type

```{r, echo=FALSE, message = FALSE, warning=FALSE}
  library(lme4)
  
  tbl_regression(glmer(data = daily2, Total_Steps ~ Pre.Post + (1|ID))) |> add_glance_source_note() |>
  modify_header(label = "**Unadjusted Model**") |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  tbl_regression(glmer(data = daily2, Total_Steps ~ Times + (1|ID))) |> add_glance_source_note()|>
  modify_header(label = "**Unadjusted Model by Time Periods**") |>
    as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  tbl_regression(glmer(data = daily2, Total_Steps ~ Times + gender + Age + rate_health + (1|ID))) |> add_glance_source_note()|>
  modify_header(label = "**Adjusted Model**") |>
    as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
```

## Difference in Effect of DCI on Step Count by Gender

```{r, echo=FALSE, message = FALSE, warning=FALSE}

  tbl_regression(lm(data = subset(daily2, gender == "Male"), Total_Steps ~ Pre.Post)) |>
  modify_header(label = "**Difference Among Males**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*")) 
  
  tbl_regression(lm(data = subset(daily2, gender == "Female"), Total_Steps ~ Pre.Post))|>
  modify_header(label = "**Difference Among Females**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  tbl_regression(summary(lm(data = daily2, Total_Steps ~ Pre.Post*gender)))|>
  modify_header(label = "**Interaction Model**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  # Diff-in-diff Plot
    plot_data <- daily2[complete.cases(daily2$gender), ] %>%
    # Make these categories instead of 0/1 numbers so they look nicer in the plot
    mutate(gender = factor(gender, labels = c("Female", "Male")),
           Pre.Post = factor(Pre.Post, labels = c("Before DCI", "After DCI"))) %>%
    group_by(gender, Pre.Post) %>%
    summarize(Avg_Steps = mean(Total_Steps, na.rm=T),
              se = sd(Total_Steps) / sqrt(n()),
              upper = Avg_Steps + (1.96 * se),
              lower = Avg_Steps + (-1.96 * se))
    
    plot_data <- labelled::copy_labels(from = daily2, to = plot_data)

  # Plot
  ggplot(plot_data, aes(x = Pre.Post, y = Avg_Steps, color = gender)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), size = 1) +
    geom_line(aes(group = gender)) +
    theme_bw() + 
    labs(title="Interaction of Gender and Time", y = "Average Daily Steps", x = "")
  
  # Model
  tbl_regression(lm(data = daily2, Total_Steps ~ gender:Pre.Post + Age + rate_health))|>
    modify_header(label = "**Interaction with Adjustment**") |> 
    add_glance_source_note() |>
    as_gt() |> gt::tab_source_note(gt::md("*Data as of June 11, 2025*"))
```

# Minutes of Moderate to Vigorous Activity (MVPA)
Calculated from Heart Rate Data as per SAP.

## Total Daily Minutes of MVPA
```{r, echo=FALSE, message = FALSE, warning=FALSE}
    # Exclude dates prior to May 16, 2024)
      
      tbl_summary(data = daily2, include=c(Total_MVPA, Moderate, Vigorous), by = Times,
                  type = all_continuous() ~ "continuous2",
                  statistic = all_continuous() ~ c(
                    "{mean} ({sd})",
                    "{median} ({p25}, {p75})",
                    "{min}, {max}"
                  ),
                  digits = all_continuous() ~ 0,
                  label = Total_MVPA ~ "Minutes of Moderate to Vigorous Activity per Day"
                  ) |> add_overall()
```

## Distribution of Daily MVPA Minutes
```{r, echo=FALSE, message = FALSE, warning=FALSE}
  mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Total_MVPA))
      mu <- labelled::copy_labels(from = daily2, to = mu)
  ggplot(daily2, aes(x = Total_MVPA, y = ..density..)) +
    geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
    geom_density(colour = "red") + theme_bw() +  
    labs(x = "MVPA Minutes", y = "Density")
  
  mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Moderate))
      mu <- labelled::copy_labels(from = daily2, to = mu)
  ggplot(daily2, aes(x = Moderate, y = ..density..)) +
    geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
    geom_density(colour = "red") + theme_bw() +  
    labs(x = "Moderate Minutes", y = "Density")
  
  mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Vigorous))
      mu <- labelled::copy_labels(from = daily2, to = mu)
  ggplot(daily2, aes(x = Vigorous, y = ..density..)) +
    geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
    geom_density(colour = "red") + theme_bw() +  
    labs(x = "Vigorous Minutes", y = "Density")
  
```

## Change in MVPA Minutes Over Time

```{r, echo=FALSE, message = FALSE, warning=FALSE}
  ggplot(daily2, aes(x = date, y = Total_MVPA)) + 
    geom_point(colour = "grey60", size = .5) +
    geom_smooth(colour = "red") + 
    scale_x_datetime(date_breaks="1 month", date_labels="%b-%Y") +
    labs(x = "MVPA Minutes", y = "Density")+
    theme_bw()
```  

## Distribution of MVPA by Time Period

```{r, echo=FALSE, message = FALSE, warning=FALSE}
  mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Total_MVPA))
      mu <- labelled::copy_labels(from = daily2, to = mu)
  ggplot(daily2, aes(x=Total_MVPA, color=Pre.Post, fill=Pre.Post)) +
    geom_histogram(aes(y=..density..), position="identity", alpha=0.2, size = .2)+
    geom_density(alpha=0) +
    geom_vline(data=mu, aes(xintercept=grp.mean, color=Pre.Post),
               linetype="dashed")+
    scale_color_manual(values=c("#E69F00", "#999999"))+
    scale_fill_manual(values=c("#E69F00", "#999999"))+
    labs(x = "MVPA Minutes", y = "Density")+
    theme_bw()
```

## Initial Table of Daily MVPA by Device and Survey Responses

```{r, echo=FALSE, message = FALSE, warning=FALSE}

  tbl_continuous(data=daily2, variable = Total_MVPA, include = c("gender", "education", "Usborn",
                                                                  "married", "children_living2", "selfemployed",
                                                                  "rate_health", "Q156_1", "Q127", "Q129", 
                                                                  "Q153")) |> add_p()
  my_data <- daily2[, c("Total_MVPA", "Age", "OMICmAge", "UCLA_Loneliness_Rev")]
  correlation::correlation(my_data)
```

## Unadjusted and Adjusted Model of Daily MVPA

```{r, echo=FALSE, message = FALSE, warning=FALSE}
  library(lme4)
  
  tbl_regression(glmer(data = daily2, Total_MVPA ~ Pre.Post + (1|ID))) |> add_glance_source_note() |>
  modify_header(label = "**Unadjusted Difference**") |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  tbl_regression(glmer(data = daily2, Total_MVPA ~ Times + (1|ID))) |> add_glance_source_note() |>
  modify_header(label = "**Unadjusted Difference for All Times**") |>
    as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
  
  tbl_regression(glmer(data = daily2, Total_MVPA ~ Times + gender + Age + rate_health +  (1|ID))) |>
  modify_header(label = "**Adjusted Difference**") |> add_glance_source_note() |>
    as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
```

# Summary of Sleep Data

## Distribution of Daily Sleep (Hours)

```{r, echo=FALSE, message = FALSE, warning=FALSE}

mu <- plyr::ddply(daily2, "Pre.Post", summarise, grp.mean=mean(Total_Sleep, na.rm=T))

mu

ggplot(daily2, aes(x = Total_Sleep, y = ..density..)) +
  geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
  geom_density(colour = "red") + theme_bw() +  
  ggtitle("Average Daily Sleep (Hours) Across All Time for Participants")+
  labs(x = "Average Daily Sleep (Hours)", y = "Density")
```

## Daily Sleep (Hours) by Time Period

```{r, echo=FALSE, message = FALSE, warning=FALSE}

# Initial Table
tbl_summary(data = daily2, by=Times, include=Total_Sleep, 
            type = all_continuous() ~ "continuous2",
            statistic = all_continuous() ~ c(
              "{mean} ({sd})",
              "{median} ({p25}, {p75})",
              "{min}, {max}"                  ),
            digits = all_continuous() ~ 0,
            label = Total_Sleep ~ "Daily Sleep (Hours)"                 ) |> 
  add_overall() 

```


## Plotting Change in Daily Sleep (Hours) Over Time

```{r, echo=FALSE, message = FALSE, warning=FALSE, fig.width=8}
ggplot(daily2, aes(x = date, y = Total_Sleep)) + 
  geom_smooth(colour = "red") + 
  scale_x_datetime(date_breaks="1 month", date_labels="%b\n%Y") +
  labs( x = "Average Daily Sleep (Hours)", y = "Density")+
  theme_bw()
```

## Daily Sleep (Hours) by Device and Survey Responses

```{r, echo=FALSE, message = FALSE, warning=FALSE}

tbl_continuous(data=daily2, variable = Total_Sleep, include = c("gender", "education", "Usborn",
                                                                "married", "children_living2", "selfemployed",
                                                                "rate_health", "Q156_1", "Q127", "Q129", 
                                                                "Q153")) |> add_p()

my_data <- daily2[, c("Total_Sleep", "Age", "OMICmAge", "UCLA_Loneliness_Rev")]
correlation::correlation(my_data)
```

## Unadjusted and Adjusted model of Daily Sleep (Hours)
Includes a random effect for participants and adjustment for device type

```{r, echo=FALSE, message = FALSE, warning=FALSE}
library(lme4)

tbl_regression(glmer(data = daily2, Total_Sleep ~ Pre.Post + (1|ID))) |> add_glance_source_note() |>
  modify_header(label = "**Unadjusted Model**") |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))

tbl_regression(glmer(data = daily2, Total_Sleep ~ Times + (1|ID))) |> add_glance_source_note()|>
  modify_header(label = "**Unadjusted Model by Time Periods**") |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))

tbl_regression(glmer(data = daily2, Total_Sleep ~ Times + gender + Age + rate_health  + (1|ID))) |> add_glance_source_note()|>
  modify_header(label = "**Adjusted Model**") |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))
```

## Difference in Effect of DCI on Step Count by Gender

```{r, echo=FALSE, message = FALSE, warning=FALSE}

tbl_regression(lm(data = subset(daily2, gender == "Male"), Total_Sleep ~ Pre.Post)) |>
  modify_header(label = "**Difference Among Males**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*")) 

tbl_regression(lm(data = subset(daily2, gender == "Female"), Total_Sleep ~ Pre.Post))|>
  modify_header(label = "**Difference Among Females**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))

tbl_regression(summary(lm(data = daily2, Total_Sleep ~ Pre.Post*gender)))|>
  modify_header(label = "**Interaction Model**") |> add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 1, 2025*"))

# Diff-in-diff Plot
plot_data <- daily2[complete.cases(daily2$gender), ] %>%
  # Make these categories instead of 0/1 numbers so they look nicer in the plot
  mutate(gender = factor(gender, labels = c("Female", "Male")),
         Pre.Post = factor(Pre.Post, labels = c("Before DCI", "After DCI"))) %>%
  group_by(gender, Pre.Post) %>%
  summarize(Avg_Steps = mean(Total_Sleep, na.rm=T),
            se = sd(Total_Sleep) / sqrt(n()),
            upper = Avg_Steps + (1.96 * se),
            lower = Avg_Steps + (-1.96 * se))

plot_data <- labelled::copy_labels(from = daily2, to = plot_data)

# Plot
ggplot(plot_data, aes(x = Pre.Post, y = Avg_Steps, color = gender)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), size = 1) +
  geom_line(aes(group = gender)) +
  theme_bw() + 
  labs(title="Interaction of Gender and Time", y = "Average Daily Sleep (Hours)", x = "")

# Model
tbl_regression(lm(data = daily2, Total_Sleep ~ gender:Pre.Post + Age + rate_health))|>
  modify_header(label = "**Interaction with Adjustment**") |> 
  add_glance_source_note() |>
  as_gt() |> gt::tab_source_note(gt::md("*Data as of June 11, 2025*"))
```
