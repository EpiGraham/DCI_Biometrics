---
title: "Wearables Pre-Post Data Report"
author: "Laura Graham"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyquant)
library(procs)
library(gtsummary)
library(readxl)
library(gridExtra)

# Load Current Step Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_Steps.RData")

# Load Current HR Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_MVPA.RData")

# Load Current Sleep Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/Daily_Sleep.RData")

# Merge all Wearables
  daily <- merge(daily_steps, daily_mvpa, by=c("ID", "date"), all.x=T, all.y=T)
  daily <- merge(daily, daily_sleep, by=c("ID", "date"), all.x=T, all.y=T)
  
  daily <- daily[,c("ID", "date", "Total_Steps", "Total_MVPA", "Total_Sleep", "HR_Avg", "HR_Max", "HR_n", "Moderate", "Vigorous", "Sleep_Start", "Sleep_End")]

  # Participant level with day daily
    participant <- daily %>%
      dplyr::group_by(ID) %>%
      dplyr::summarize(Avg_Daily_Steps = mean(Total_Steps, na.rm=T), 
                       Avg_MVPA = mean(Total_MVPA, na.rm=T),
                       Avg_Sleep = mean(Total_Sleep, na.rm=T),
                       start_date = min(date), last_date = max(date)) 
  
    # Pre-Post Determinimation
    daily$Pre.Post <- ifelse(daily$date < as.Date('2024-09-15'), "Pre", "Post")
    daily$Pre.Post <- factor(daily$Pre.Post, levels=c("Pre", "Post"))
      table(daily$Pre.Post)
    daily$Times <- ifelse(daily$date < as.Date('2024-05-16'), "1. May 15 or earlier",
                          ifelse(daily$date <= as.Date('2024-06-28'), "2. Pre Intro to DCI (06/28/2024)",
                                 ifelse(daily$date <= as.Date('2024-08-01'), "3. Pre Virtual Orientation (08/01/2024)",
                                        ifelse(daily$date < as.Date('2024-09-15'), "4. Pre In-Person Orientation (09/15/2024)", "5. Post DCI Orientation"))))
      table(daily$Times)

# Demographics
  Demo <- read_excel("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Wearables Data/2024 Master List.xlsx", sheet = "Master")

# Survey Data
  load("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/Survey Data/Survey_2024_07092024.RData")
  survey <- survey2024[,c("id_number2", "Q156_1", "Q127", "Q129", "Q153")]
  
# TruDiagnostics
  Trudiagnostics <- read.csv("~/Library/CloudStorage/GoogleDrive-lagraham@stanford.edu/Shared drives/Secure: DCI Research/Analysis_Graham/TruDiagnostics Data/PopulationData_11192024.csv", header=TRUE)
  Trudiagnostics <- Trudiagnostics[,c("Patient.ID", "Telomere.Values", "OMICmAge", "Decimal.Chronological.Age")]

# Combine all data
  daily2 <- merge(daily, Demo, by = "ID", all.x = T)
  daily2 <- merge(daily2, survey, by.x = "Old ID", by.y = "id_number2", all.x = T)
  daily2 <- merge(daily2, Trudiagnostics, by.x = "TruDiagnosticID", by.y = "Patient.ID", all.x = T)

  # Subsetting Data
    daily2 <- subset(daily2, date > as.Date("2024-05-16"))
    daily2 <- subset(daily2, date < as.Date("2025-06-01"))
    
    names(daily2)
 
  daily2 <- daily2[,c("ID", "date", "Total_Steps", "Total_MVPA", "Total_Sleep", "HR_Avg", "HR_Max", "HR_n", "Moderate", "Vigorous", "Sleep_Start", "Sleep_End", "Pre.Post", "Times",
                  "Cohort", "gender", "Surv_year", "birth_year", "Age", "education", 
                  "Usborn", "married",  "children_living2", "selfemployed", "work_years", "rate_health", "Big5_Agreeable", "Big5_Conscientious",
                  "Big5_Extravert", "Big5_Neurotic", "Big5_Open", "UCLA_Loneliness3", "UCLA_Loneliness_Rev", "Need_for_Cognition", "Ryff_Purpose", "Q156_1",  
                  "Q127", "Q129", "Q153", "Telomere.Values", "OMICmAge", "Decimal.Chronological.Age")]

# Cleaning Labels
  daily2 <- labelled::copy_labels(from = survey, to = daily2)

  labelled::var_label(daily2$Pre.Post) <- "Pre/Post DCI"
  labelled::var_label(daily2$gender) <- "Gender"
  labelled::var_label(daily2$education) <- "Education"
  labelled::var_label(daily2$Usborn) <- "Born in US"
  labelled::var_label(daily2$married) <- "Marital Status"
  labelled::var_label(daily2$children_living2) <- "Number of Children"
  labelled::var_label(daily2$selfemployed) <- "Self-Employed"
    daily2$rate_health <- factor(daily2$rate_health, levels = c("Excellent", "Very Good", "Good", "Fair", "Poor"))
  labelled::var_label(daily2$rate_health) <- "Self-Reported Health"
  daily2$Q156_1<- plyr::revalue(as.character(daily2$Q156_1), 
                                     c("5" = "Very Satisfied", 
                                       "4" = "Satisfied", 
                                       "3" = "Neither Dissatisfied nor Satisfied", 
                                       "2" = "Dissatisfied", 
                                       "1" = "Very Dissatisfied"))
  labelled::var_label(daily2$Q156_1) <- "How satisfied are you with your health?"
  daily2 <- labelled::copy_labels(from = survey, to = daily2)
  

```
# Summary

DCI participants take an average of `r round(mean(daily2$Total_Steps, na.rm=T), digits = 0)` steps per day which includes an average of `r round(mean(daily2$Total_MVPA, na.rm=T), digits = 0)` minutes of moderate to vigorous physical activity (MVPA).


## Notes
All models include a random effect for the participant and are adjusted for device type used to capture the data.

## Data Frame Summary

This is a summary of all data included in the final analytic sample. 

Unit of analysis is the participant-day. Total number is the number of participant day with at least one steps, MVPA, or sleep measured.

```{r, warning=FALSE, echo=FALSE, message = FALSE}

skimr::skim(daily2)

```

## Summary of Participants Included in Wearables Analysis

```{r, warning=FALSE, echo=FALSE, message = FALSE, results='asis'}

participant <- daily2 %>%
  dplyr::group_by(ID) %>%
  dplyr::summarize(Avg_Daily_Steps = mean(Total_Steps, na.rm=T), 
                   Avg_Daily_MVPA = mean(Total_MVPA, na.rm=T),
                   Avg_Daily_Sleep = mean(Total_Sleep, na.rm=T),
                   Med_Daily_Steps = median(Total_Steps, na.rm=T), 
                   Med_Daily_MVPA = median(Total_MVPA, na.rm=T),
                   Med_Daily_Sleep = median(Total_Sleep, na.rm=T),
                   
                   start_date = min(date), last_date = max(date)) 

participant$time <- participant$last_date-participant$start_date

# Merge in demographics
  Demo2 <- daily2[,c("ID", "Cohort", "gender", "Surv_year", "Age", "education", "Usborn", "married", "children_living2",
                     "selfemployed", "work_years", "rate_health")]
  Demo2 <- distinct(Demo2)
  participant <- merge(participant, Demo2, by="ID", all.x=T)
  
# Variable Levels
  participant <- labelled::copy_labels(from = survey, to = participant)
  
  labelled::var_label(participant$Avg_Daily_Steps) <- "Average Daily Steps"
  labelled::var_label(participant$Avg_Daily_MVPA) <- "Average Daily Minutes of Moderate to Vigorous Physcial Activity (MVPA)"
  labelled::var_label(participant$Avg_Daily_Sleep) <- "Average Daily Sleep Hours"
  labelled::var_label(participant$start_date) <- "Earliest Recorded Date"
  labelled::var_label(participant$last_date) <- "Last Recorded Date"
  labelled::var_label(participant$time) <- "Days of Observation"
  labelled::var_label(participant$gender) <- "Sex"
  labelled::var_label(participant$Age) <- "Age, years"
  labelled::var_label(participant$Usborn) <- "US born"
  labelled::var_label(participant$married) <- "Marital Status"
  labelled::var_label(participant$children_living2) <- "Number of Children"
  labelled::var_label(participant$selfemployed) <- "Self-Employed"
  labelled::var_label(participant$work_years) <- "Working Years"
  labelled::var_label(participant$rate_health) <- "Self-Rated Health at the Start of DCI"
  
  
tbl_summary(participant, include = c("Avg_Daily_Steps", "Avg_Daily_MVPA", "Avg_Daily_Sleep", "start_date", "last_date", "time",
                                     "gender", "Age", "Usborn", "married", "children_living2", "selfemployed", "work_years", "rate_health"))


```

## Distribution of Daily Wearable Measures

```{r, warning=FALSE, echo=FALSE, message = FALSE, results='asis', fig.height=6}

p1 <- ggplot(daily2, aes(x = Total_Steps, y = ..density..)) +
  geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
  geom_density(colour = "red") + theme_bw() +  
  ggtitle("Average Daily Step Counts Across All Time for Participants")+
  labs(x = "Average Daily Steps", y = "Density")

p2 <- ggplot(daily2, aes(x = Total_MVPA, y = ..density..)) +
  geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
  geom_density(colour = "red") + theme_bw() +  
  ggtitle("Average Daily MVPA Across All Time for Participants")+
  labs(x = "Average Daily MVPA", y = "Density")

p3 <- ggplot(daily2, aes(x = Total_Sleep, y = ..density..)) +
  geom_histogram(fill = "cornsilk", colour = "grey60", size = .2) +
  geom_density(colour = "red") + theme_bw() +  
  ggtitle("Average Daily Sleep Hours Across All Time for Participants")+
  labs(x = "Average Daily Sleep Hours", y = "Density")

grid.arrange(p1, p2, p3, nrow = 3)

```